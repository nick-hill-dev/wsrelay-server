<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>WebSocket Relay Tester</title>
</head>

<body>
    <style>
        button {
            height: 20pt;
        }

        #messagesDiv {
            color: blue;
            font-family: Consolas;
            font-size: 12pt;
            line-height: 0;
            max-height: 50vh;
            overflow-y: scroll;
            background-color: rgb(240, 240, 240);
            margin: 5px 0 5px 0;
        }

        #connectedDiv {
            display: none;
        }
    </style>
    <script>
        let client;

        function log(text) {
            let p = document.createElement('p');
            p.textContent = text;
            const div = document.getElementById('messagesDiv');
            div.appendChild(p);
            div.scrollTop = div.scrollHeight;
        }

        function sendInternal(command) {
            log(`Out: ${command}`);
            client.send(command);
        }

        function sendUtf8() {
            const text = document.getElementById('dataToSendInput').value;
            sendInternal(text);
        }

        function sendBinary() {
            const input = document.getElementById('dataToSendInput').value;
            log(`Out (binary): ${input}`);
            const byteArray = input.split(',').map(num => parseInt(num.trim(), 10));
            const binaryData = new Uint8Array(byteArray);
            client.send(binaryData);
        }

        function connect() {
            let address = document.getElementById('addressTextBox').value;
            let protocol = 'relay';
            log(`Connecting to ${address}, protocol ${protocol}`);
            client = new WebSocket(address, protocol);
            client.onopen = () => {
                sendInternal('^19');
                document.getElementById('connectButton').disabled = true;
                document.getElementById('disconnectButton').disabled = false;
                document.getElementById('connectedDiv').style.display = 'inline';
            };
            client.onerror = ev => {
                log(`WebSocket error.`);
            };
            client.onclose = (ev) => {
                log(`WebSocket closed: ${ev.code}`);
                document.getElementById('connectButton').disabled = false;
                document.getElementById('disconnectButton').disabled = true;
                document.getElementById('connectedDiv').style.display = 'none';
            };
            client.onmessage = ev => {
                if (typeof ev.data === 'string') {
                    log(`In: ${ev.data}`);
                } else {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const byteArray = new Uint8Array(event.target.result);
                        log(`In: ${Array.from(byteArray).join(', ')}`);
                    };
                    reader.readAsArrayBuffer(ev.data); // Read the Blob as an ArrayBuffer
                }
            };
        }

        function disconnect() {
            client.close();
        }
    </script>
    <input type="text" id="addressTextBox" value="ws://localhost:22002" />
    <button id="connectButton" onclick="connect()">Connect</button>
    <button id="disconnectButton" disabled="disabled" onclick="disconnect()">Disconnect</button>
    <div id="messagesDiv">
    </div>
    <div id="connectedDiv">
        <input type="text" id="dataToSendInput" value="* Hello World!" />
        <button id="sendUtf8Button" onclick="sendUtf8()">Send UTF8</button>
        <button id="sendBinaryButton" onclick="sendBinary()">Send Binary</button>
        <p>(When sending binary please specify bytes seperated by commas I.E. 1, 2, 3 etc)</p>
    </div>
</body>

</html>